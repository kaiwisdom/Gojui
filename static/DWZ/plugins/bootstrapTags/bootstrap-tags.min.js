/**
 * Bootstrap plugin - TAGS
 * @Author 上海巨人网络有限公司 应卓
 * 修改 - K'naan
 */
!function(a){a.fn.tags=function(b){var c={url:"",global:!1,type:"GET",parameterName:"labelValue",max:0,clearNotFound:!1};return b=b||{},a.extend(c,b),this.each(function(){function k(){var e,g;if(!(c.max>0&&i&&i.length+1>c.max)){if(!c.url||0==c.url.length)return!1;if(e=f.val(),0==e.length)return!1;h=[],g=null,a.ajax({url:c.url,global:c.global,type:c.type,data:{term:e},dataType:"json",success:function(e){if(0!=e.length){d&&d.length||(d=a('<ul class="tags-menu"></ul>')),d.html("").hide().appendTo(b);for(var i=0;i<e.length;i++)g=a('<li class="tags-item">'+e[i].label+"</li>").attr("data-value",e[i].value),g.appendTo(d),h.push(e[i].label);d.css("top",f.position().top+28).css("left",f.position().left).show(),d.find("li").hover(function(){a(this).addClass("tags-highlight").siblings().removeClass("tags-highlight")},function(){d.find("li").removeClass("tags-highlight")}),d.find("li").click(function(){var e=a(this).text(),g=a(this).data("value"),h=!1;return b.find("input:hidden").each(function(){return a(this).val()==g?(h=!0,void 0):void 0}),h?(f.val(""),d.remove(),!1):(l(e,g,f,b,c.parameterName),d.remove(),f.val(""),void 0)})}}})}}function l(c,d,e,f,g){var j,h=a('<span class="label label-tag" data-value="'+d+'" style="margin-left: 1px; margin-top: 1px;"><i class="fa fa-tag"></i> '+c+'&nbsp;&nbsp;<a href="#" class="close">&times;</a></span>');h.insertBefore(e).find("a.close").click(function(){var c=h.data("value");f.find("input:hidden").each(function(){return a(this).val()==c?(a(this).remove(),!1):void 0}),h.remove(),i=b.find("input:hidden")}),j=a('<input type="hidden" name="'+g+'">').val(d),j.appendTo(f),i=b.find("input:hidden")}var f,h,i,j,b=a(this),d=b.find(".tags-menu");b.find("div:nth-child(1)"),f=b.find("input:last"),h=[],b.click(function(){return a(this).find("input").focus(),!0}),f.blur(function(){var a=setTimeout(function(){d.remove()},200);null!=a&&clearTimeout(a)}),a("html").on("click",function(c){a(c.target).closest(b).length<1&&d.length&&d.remove()}),a.browser.msie&&"8.0"==a.browser.version?f.on("propertychange",function(){clearTimeout(j),j=setTimeout(k,300)}):f.bind("input",function(){clearTimeout(j),j=setTimeout(k,300)}),f.keyup(function(e){var k,m,n,o,p,q,r,s,t,g=e.which,j=1==d.length;if(27==g)d.remove();else if(40==g){if(!j)return!1;k=a(".tags-highlight",d),m=d.find("li:first"),0==k.length?m.addClass("tags-highlight"):(n=k.removeClass("tags-highlight").next(),n.length?n.addClass("tags-highlight"):m.addClass("tags-highlight"))}else if(38==g){if(!j)return!1;k=a(".tags-highlight",d),o=d.find("li:last"),0==k.length?o.addClass("tags-highlight"):(p=k.removeClass("tags-highlight").prev(),p.length?p.addClass("tags-highlight"):o.addClass("tags-highlight"))}else if(13==g){if(c.max>0&&i&&i.length+1>c.max)return;if(q=!1,r=!1,s=d&&d.find(".tags-highlight"),s&&s.length>0)q=s.text(),r=s.data("value");else{if(q=a.trim(f.val()),0==q.length)return!1;if(c.clearNotFound&&-1==a.inArray(q,h))return f.val(""),!1;r=q}if(!q)return;if(t=!1,i&&i.length&&i.each(function(){return a(this).val()==r?(t=!0,void 0):void 0}),t)return f.val(""),!1;l(q,r,f,b,c.parameterName),f.val(""),d.length>0&&d.remove()}else if(8==g&&a.trim(0==f.val().length))return d.remove(),!1})})}}(jQuery);