!function(a){a.fn.Huploadify=function(b){var c='<div id="${fileID}" class="uploadify-queue-item"><div class="uploadify-info"><span class="up_filename">${fileName}</span><span class="btn btn-default btn-sm uploadbtn">上传</span><span class="delfilebtn">&times;</span></div><div class="preview-box"></div><div class="uploadify-progress"><div class="uploadify-progress-bar"></div></div></div>',d={fileTypeExts:"",uploader:"",auto:!1,method:"post",multi:!1,formData:{},fileObjName:"file",fileSizeLimit:204800,previewImg:!1,previewLoadimg:null,dragDrop:!1,showUploadedPercent:!0,showUploadedSize:!1,buttonText:"选择文件",removeTimeout:1e3,itemTemplate:c,breakPoints:!1,fileSplitSize:1048576,getUploadedSize:null,saveUploadedSize:null,saveInfoLocal:!1,onUploadStart:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onInit:null,onCancel:null,onSelect:null},e=a.extend(d,b),f=function(a,b){return a=a>1048576&&!b?(Math.round(100*a/1048576)/100).toString()+"MB":(Math.round(100*a/1024)/100).toString()+"KB"},g=function(a,b){for(var c=0;c<b.length;c++)if(b[c].index==a)return b[c];return!1},h=function(a){var d,e,b=[],c=a.split(";");for(d=0,e=c.length;e>d;d++)b.push(c[d].split(".").pop());return b},i={zip:["application/x-zip-compressed"],jpg:["image/jpeg"],png:["image/png"],gif:["image/gif"],doc:["application/msword"],xls:["application/msexcel"],docx:["application/vnd.openxmlformats-officedocument.wordprocessingml.document"],xlsx:["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],ppt:["application/vnd.ms-powerpoint"],pptx:["application/vnd.openxmlformats-officedocument.presentationml.presentation"],mp3:["audio/mp3"],mp4:["video/mp4"],pdf:["application/pdf"]},j=function(a){return i[a]},k=function(a){var d,e,f,b=h(a),c=[];for(d=0,e=b.length;e>d;d++)f=j(b[d]),f&&c.push(f);return c.join(",")},l=function(a,b,c,d){b.open(e.method,a,!0),b.setRequestHeader("X-Requested-With","XMLHttpRequest");var f=new FormData;if(f.append(e.fileObjName,c),d)for(key in d)f.append(key,d[key]);b.send(f)},m=null;return this.each(function(){var c,d,g,b=a(this);b.addClass("uploadify"),c=b.attr("id"),d='<input id="'+c+'_selectbtn" class="selectbtn" style="display:none;" type="file" name="fileselect[]"',d+=e.multi?" multiple":"",d+=' accept="',d+=k(e.fileTypeExts),d+='"/>',d+='<a id="'+c+'_fileuploadbtn" href="javascript:void(0)" class="btn btn-default btn-sm Huploadify-button">',d+=e.buttonText,d+="</a>",g='<div id="'+c+'_fileuploadqueue" class="uploadify-queue"></div>',b.append(d+g),m={uploadAllowed:!0,fileInput:b.find(".selectbtn"),uploadFileList:b.find(".uploadify-queue"),url:e.uploader,fileFilter:[],uploadOver:!1,filter:function(b){var g,i,j,c=[],d=h(e.fileTypeExts);if(d.length>0)for(g=0,i=b.length;i>g;g++)j=b[g],parseInt(f(j.size,!0))>e.fileSizeLimit?alert("文件"+j.name+"大小超出限制！"):a.inArray(j.name.split(".").pop().toLowerCase(),d)>=0?c.push(j):alert("文件"+j.name+"类型不允许！");return c},funSelect:function(d){var g,h,i,j,k,l,n,o,p,q,r;for(b.find(".uploadify-queue").show(),g=0,h=d.length;h>g;g++)i=d[g],j=a(e.itemTemplate.replace(/\${fileID}/g,c+"_fileuploadfile_"+i.index).replace(/\${fileName}/g,i.name).replace(/\${fileSize}/g,f(i.size)).replace(/\${instanceID}/g,b.attr("id"))),e.auto&&j.find(".uploadbtn").remove(),k=0,l="0KB",n="0%",e.breakPoints&&(o=this.funGetUploadedSize(i),o>i.size&&(o=i.size),k=100*(o/i.size)+"%",l=f(o),n=(100*(o/i.size)).toFixed(2)+"%",j.find(".uploadify-progress-bar").css("width",k)),this.uploadFileList.append(j),e.previewImg?(p=j.find(".preview-box"),e.previewLoadimg&&p.html('<img src="'+e.previewLoadimg+'" height="114">'),m.previewImg(i,p)):j.find(".preview-box").remove(),e.showUploadedSize&&(q='<span class="progressnum"><span class="uploadedsize">'+l+'</span>/<span class="totalsize">${fileSize}</span></span>'.replace(/\${fileSize}/g,f(i.size)),j.find(".uploadify-progress").after(q)),e.showUploadedPercent&&(r='<span class="up_percent">'+n+"</span>",j.find(".uploadify-progress").after(r)),e.onSelect&&e.onSelect(d),e.auto?this.funUploadFile(i):j.find(".uploadbtn").on("click",function(a){return function(){m.funUploadFile(a)}}(i)),j.find(".delfilebtn").on("click",function(a){return function(){m.funDeleteFile(a.index)}}(i))},onProgress:function(a,d,g){var k,l,m,n,h=b.find("#"+c+"_fileuploadfile_"+a.index+" .uploadify-progress"),i=d,j=h.attr("lastLoaded")||0;d-=parseInt(j),k=h.children(".uploadify-progress-bar"),l=e.breakPoints?parseFloat(k.get(0).style.width||0):0,m=(100*(d/g)+l).toFixed(2),n=m>100?"99.99%":m+"%",e.showUploadedSize&&(h.nextAll(".progressnum .uploadedsize").text(f(d)),h.nextAll(".progressnum .totalsize").text(f(g))),e.showUploadedPercent&&h.nextAll(".up_percent").text(n),k.css("width",n),i<e.fileSplitSize?h.attr("lastLoaded",i):h.removeAttr("lastLoaded")},previewImg:function(a,b){if(a&&b.length){var c=new FileReader;c.onload=function(a){var c='<span class="img-box"><img src="'+a.target.result+'"></span>';b.html(c)},c.readAsDataURL(a)}},funGetProgressWidth:function(a){var d=b.find("#"+c+"_fileuploadfile_"+a+" .uploadify-progress-bar");return d.get(0).style.width||""},funGetUploadedSize:function(a){return e.getUploadedSize?e.getUploadedSize(a):e.saveInfoLocal?parseInt(localStorage.getItem(a.name))||0:void 0},funSaveUploadedSize:function(a,b){e.saveUploadedSize?e.saveUploadedSize(a,b):e.saveInfoLocal&&localStorage.setItem(a.name,b)},funGetFiles:function(a){var c,d,b=a.target.files||a.dataTransfer.files;for(b=this.filter(b),c=0,d=b.length;d>c;c++)this.fileFilter.push(b[c]);return this.funDealFiles(b),this},funDealFiles:function(a){var e,f,d=b.find(".uploadify-queue .uploadify-queue-item").length;for(e=0,f=a.length;f>e;e++)a[e].index=++d,a[e].id=c+"_fileuploadfile_"+a[e].index;return this.funSelect(a),this},funDeleteFile:function(a){var d,f,g;for(d=0,f=this.fileFilter.length;f>d;d++)if(g=this.fileFilter[d],g.index==a){e.breakPoints&&(this.uploadAllowed=!1),this.fileFilter.splice(d,1),b.find("#"+c+"_fileuploadfile_"+a).fadeOut("normal",function(){var a=b.find(".uploadify-queue-item:visible").length;0==a&&b.find(".uploadify-queue").hide()}),m.fileInput.val(""),e.onCancel&&e.onCancel(g);break}return this},funUploadFile:function(a){var j,k,n,o,p,d=!1,f=a,g=b.find("#"+c+"_fileuploadfile_"+a.index),h=function(){m.uploadOver&&(g.find(".uploadify-progress-bar").css("width","100%"),e.showUploadedSize&&g.find(".uploadedsize").text(g.find(".totalsize").text()),e.showUploadedPercent&&g.find(".up_percent").text("100%"))};try{d=new XMLHttpRequest}catch(i){d=ActiveXobject("Msxml12.XMLHTTP")}e.breakPoints&&(j=a.name,k=a.id,n=a.index,o=a.size,p=parseInt(this.funGetUploadedSize(f)),a=f.slice(p,p+e.fileSplitSize),a.name=j,a.id=k,a.index=n),d.upload&&p!==!1&&(d.upload.addEventListener("progress",function(b){m.onProgress(a,b.loaded,f.size)},!1),d.onreadystatechange=function(){4==d.readyState&&(m.uploadOver=!0,200==d.status?(JSON.parse(d.responseText),e.breakPoints?(p+=e.fileSplitSize,m.funSaveUploadedSize(f,p),o>p?(m.uploadOver=!1,m.uploadAllowed&&(a=f.slice(p,p+e.fileSplitSize),a.name=j,a.id=k,a.index=n,a.size=o,l(m.url,d,a,e.formData))):h()):h(),m.uploadOver&&(e.onUploadSuccess&&e.onUploadSuccess.call(b,f,d.responseText),setTimeout(function(){b.find("#"+c+"_fileuploadfile_"+f.index).fadeOut("normal",function(){var a=b.find(".uploadify-queue-item:visible").length;0==a&&b.find(".uploadify-queue").hide()})},e.removeTimeout))):m.uploadOver&&e.onUploadError&&e.onUploadError(f,d.responseText),m.uploadOver&&(e.onUploadComplete&&e.onUploadComplete(f,d.responseText),m.fileInput.val("")))},e.onUploadStart&&e.onUploadStart(),e.formData.fileName=f.name,e.formData.lastModifiedDate=f.lastModifiedDate.getTime(),m.uploadAllowed=!0,l(this.url,d,a,e.formData))},init:function(){this.fileInput.length>0&&this.fileInput.change(function(a){m.funGetFiles(a)}),b.find(".Huploadify-button").on("click",function(){b.find(".selectbtn").trigger("click")}),e.onInit&&e.onInit()}},e.dragDrop&&(b[0].ondragover=function(a){return a.preventDefault(),!0},b[0].ondrop=function(a){a.stopPropagation(),a.preventDefault(),m.funGetFiles(a)}),m.init()}),{stop:function(){m.uploadOver=!1,m.uploadAllowed=!1},upload:function(a){var b,c,d;if("*"===a)for(b=0,c=m.fileFilter.length;c>b;b++)m.funUploadFile(m.fileFilter[b]);else d=g(a,m.fileFilter),d&&m.funUploadFile(d)},cancel:function(a){if("*"===a)for(var b=0,c=m.fileFilter.length;c>b;b++)m.funDeleteFile(++b);else m.funDeleteFile(a)},disable:function(b){var c=b?a("file_upload_"+b+"-button"):a("body");c.find(".Huploadify-button").prop("disabled",!0).off("click")},ennable:function(b){var c=b?a("file_upload_"+b+"-button"):a("body");c.find(".Huploadify-button").prop("disabled",!1).on("click",function(){c.find(".selectbtn").trigger("click")})}}}}(jQuery);